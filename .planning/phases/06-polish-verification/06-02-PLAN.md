---
phase: 06-polish-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/rbac/casbin_test.go
  - internal/usecase/project_usecase_test.go
  - internal/app/server_test.go
autonomous: true

must_haves:
  truths:
    - "internal/rbac tests pass (TestNewCasbinEnforcer_Success no longer panics)"
    - "internal/usecase tests pass (TestProjectUsecase_GetProjectByID_Success no longer panics)"
    - "All previously-passing test packages continue to pass"
  artifacts:
    - path: "internal/rbac/casbin_test.go"
      provides: "Fixed RBAC enforcer test"
    - path: "internal/usecase/project_usecase_test.go"
      provides: "Fixed project usecase test"
  key_links:
    - from: "internal/rbac/casbin_test.go"
      to: "internal/rbac/casbin.go"
      via: "NewCasbinEnforcer constructor"
      pattern: "NewCasbinEnforcer"
    - from: "internal/usecase/project_usecase_test.go"
      to: "internal/usecase/project_usecase.go"
      via: "GetProjectByID method"
      pattern: "GetProjectByID"
---

<objective>
Fix the 3 failing test packages (internal/rbac, internal/usecase, internal/app) identified in the Phase 6 research to establish a green test suite baseline before the final verification pass.

Purpose: A green test suite is required before the comprehensive lint pass (Plan 04) and final verification (Plan 05) can meaningfully validate the codebase.
Output: All fixable test packages passing. internal/app tests documented as environment-dependent if they cannot be fixed without network access.
</objective>

<execution_context>
@/home/ilmannafi/.claude/get-shit-done/workflows/execute-plan.md
@/home/ilmannafi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-polish-verification/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix nil pointer panics in rbac and usecase test packages</name>
  <files>
    internal/rbac/casbin_test.go
    internal/usecase/project_usecase_test.go
  </files>
  <action>
  Fix the two test packages with nil pointer dereference panics:

  1. **internal/rbac** - `TestNewCasbinEnforcer_Success` nil pointer:
     - Run `go test -v -run TestNewCasbinEnforcer_Success ./internal/rbac/` to see the exact panic stacktrace
     - The test likely fails because it calls NewCasbinEnforcer without proper setup (missing database connection or model path)
     - Investigate what NewCasbinEnforcer expects: check if it needs a real DB connection, GORM adapter, or model file
     - Fix by either: (a) providing a proper SQLite in-memory database for the test, (b) mocking the adapter, or (c) fixing the nil check in the production code if it should handle nil gracefully
     - Follow existing test patterns: use `setupTestDB` helper if available, use `zerolog.Nop()` for logger

  2. **internal/usecase** - `TestProjectUsecase_GetProjectByID_Success` nil pointer:
     - Run `go test -v -run TestProjectUsecase_GetProjectByID_Success ./internal/usecase/` to see the exact panic stacktrace
     - This likely fails due to a mock not being properly configured after Phase 5 context propagation changes
     - Check if the mock's `.On()` calls match the updated method signatures (context.Context as first param)
     - Check if all required mock dependencies are initialized (not nil)
     - Fix the mock setup to match current interface signatures

  For both: after fixing, run the entire package test suite to confirm no other tests break.
  </action>
  <verify>Run `go test -v ./internal/rbac/ 2>&1 | tail -20` -- must show PASS. Run `go test -v ./internal/usecase/ 2>&1 | tail -20` -- must show PASS. Run `go test ./... -count=1 2>&1 | grep -E "FAIL|ok" | sort` to get full test suite status.</verify>
  <done>internal/rbac and internal/usecase test packages pass. Zero nil pointer panics. No regressions in other packages.</done>
</task>

<task type="auto">
  <name>Task 2: Assess and address internal/app test failures</name>
  <files>internal/app/server_test.go</files>
  <action>
  The internal/app tests fail because they attempt network calls to test.supabase.co for JWKS endpoint resolution. Assess and fix:

  1. Run `go test -v ./internal/app/ 2>&1 | head -50` to see the exact failure
  2. Determine if the tests can be fixed by:
     a. Mocking the JWKS endpoint (preferred -- use httptest.NewServer to serve test JWKS)
     b. Adding a build tag or environment check to skip network-dependent tests
     c. Restructuring the server initialization to accept a JWT verifier interface for testability

  3. If the fix is straightforward (mock the JWKS endpoint or add env check):
     - Implement the fix
     - Verify tests pass in the local environment

  4. If the fix requires significant refactoring (e.g., restructuring server init):
     - Add `t.Skip("requires network access to Supabase JWKS endpoint")` to affected tests
     - Add a comment explaining what would be needed to make them run offline
     - This is acceptable -- the research noted these are pre-existing failures, not caused by Phase 6

  Do NOT break existing passing tests while fixing these.
  Do NOT add new dependencies for this fix -- use standard library httptest if mocking.
  </action>
  <verify>Run `go test -v ./internal/app/ 2>&1 | tail -20` -- must either PASS or show SKIP (not FAIL). Run `go test ./... -count=1 2>&1 | grep FAIL` -- must show zero FAIL lines (skipped tests are OK).</verify>
  <done>internal/app tests either pass or are explicitly skipped with clear justification. Zero FAIL results across the entire test suite.</done>
</task>

</tasks>

<verification>
1. `go test ./internal/rbac/ -count=1` passes
2. `go test ./internal/usecase/ -count=1` passes
3. `go test ./internal/app/ -count=1` passes or shows SKIP (not FAIL)
4. `go test ./... -count=1 2>&1 | grep FAIL` returns empty
</verification>

<success_criteria>
- All 3 previously-failing test packages are either passing or explicitly skipped
- Zero FAIL results in the full test suite
- No regressions in previously-passing test packages
</success_criteria>

<output>
After completion, create `.planning/phases/06-polish-verification/06-02-SUMMARY.md`
</output>
