---
phase: 05-deep-architecture-improvements
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - internal/usecase/repo/interfaces.go
  - internal/usecase/repo/project_repository.go
  - internal/usecase/repo/modul_repository.go
  - internal/usecase/project_usecase.go
  - internal/usecase/modul_usecase.go
  - internal/usecase/auth_usecase.go
  - internal/usecase/statistic_usecase.go
  - internal/usecase/health_usecase.go
  - internal/usecase/test_mocks.go
  - internal/controller/http/project_controller.go
  - internal/controller/http/modul_controller.go
  - internal/controller/http/auth_controller.go
  - internal/controller/http/statistic_controller.go
  - internal/controller/http/health_controller.go
  - internal/usecase/project_usecase_test.go
  - internal/usecase/modul_usecase_test.go
  - internal/usecase/auth_usecase_test.go
  - internal/usecase/statistic_usecase_test.go
  - internal/usecase/health_usecase_test.go
  - internal/controller/http/project_controller_test.go
  - internal/controller/http/modul_controller_test.go
  - internal/controller/http/auth_controller_test.go
  - internal/controller/http/statistic_controller_test.go
  - internal/controller/http/health_controller_test.go
  - internal/usecase/auth_integration_test.go
autonomous: true

must_haves:
  truths:
    - "Every ProjectRepository and ModulRepository method accepts context.Context as first parameter"
    - "Every ProjectUsecase, ModulUsecase, AuthUsecase, StatisticUsecase, and HealthUsecase method accepts context.Context as first parameter"
    - "All corresponding controllers extract c.UserContext() and pass it through"
    - "Repository implementations use db.WithContext(ctx) for all GORM queries"
    - "HealthUsecase direct DB calls use db.WithContext(ctx)"
    - "go build ./... compiles with zero errors"
    - "go test ./... -count=1 passes"
  artifacts:
    - path: "internal/usecase/repo/interfaces.go"
      provides: "Updated ProjectRepository, ModulRepository interfaces with context.Context (adding to Role/Permission/User from Plan 05-03)"
  key_links:
    - from: "internal/controller/http/project_controller.go"
      to: "internal/usecase/project_usecase.go"
      via: "c.UserContext() passed as ctx"
      pattern: "c\\.UserContext\\(\\)"
    - from: "internal/usecase/auth_usecase.go"
      to: "domain.AuthService"
      via: "AuthService already accepts context.Context -- just thread it from controller"
      pattern: "ctx,"
    - from: "internal/usecase/health_usecase.go"
      to: "GORM db"
      via: "Direct db.WithContext(ctx) for health check queries"
      pattern: "db\\.WithContext\\(ctx\\)"
---

<objective>
Add context.Context propagation to Project, Modul, Auth, Statistic, and Health domains: interfaces, implementations, controllers, mocks, and tests.

Purpose: Complete context propagation for non-TUS domains, covering 5 remaining domain areas.
Output: All Project, Modul, Auth, Statistic, and Health layer methods accept context.Context.
</objective>

<execution_context>
@/home/ilmannafi/.claude/get-shit-done/workflows/execute-plan.md
@/home/ilmannafi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deep-architecture-improvements/05-RESEARCH.md
@.planning/phases/05-deep-architecture-improvements/05-03-SUMMARY.md

@internal/usecase/repo/interfaces.go
@internal/usecase/project_usecase.go
@internal/usecase/modul_usecase.go
@internal/usecase/auth_usecase.go
@internal/usecase/statistic_usecase.go
@internal/usecase/health_usecase.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context.Context to Project and Modul domains</name>
  <files>
    internal/usecase/repo/interfaces.go
    internal/usecase/repo/project_repository.go
    internal/usecase/repo/modul_repository.go
    internal/usecase/project_usecase.go
    internal/usecase/modul_usecase.go
    internal/usecase/test_mocks.go
    internal/controller/http/project_controller.go
    internal/controller/http/modul_controller.go
    internal/usecase/project_usecase_test.go
    internal/usecase/modul_usecase_test.go
    internal/controller/http/project_controller_test.go
    internal/controller/http/modul_controller_test.go
  </files>
  <action>
    1. **ProjectRepository interface** (`interfaces.go`):
       - Add `ctx context.Context` to all 7 methods: Create, GetByID, GetByIDs, GetByUserID, CountByUserID, Update, Delete.

    2. **ProjectRepository implementation** (`project_repository.go`):
       - Add ctx to each method, use `r.db.WithContext(ctx)` for all queries.

    3. **ModulRepository interface** (`interfaces.go`):
       - Add `ctx context.Context` to all 8 methods: Create, GetByID, GetByIDs, GetByUserID, CountByUserID, Update, Delete, UpdateMetadata.

    4. **ModulRepository implementation** (`modul_repository.go`):
       - Add ctx to each method, use `r.db.WithContext(ctx)` for all queries.

    5. **ProjectUsecase interface + implementation** (`project_usecase.go`):
       - Add ctx to all interface methods.
       - Pass ctx to all repo calls.
       - IMPORTANT: The Download method may spawn goroutines for cleanup. These goroutines must use `context.Background()` (not the request ctx) since they outlive the HTTP request. See research pitfall #1.

    6. **ModulUsecase interface + implementation** (`modul_usecase.go`):
       - Add ctx to all interface methods.
       - Pass ctx to all repo calls.
       - Same goroutine concern as ProjectUsecase for any cleanup operations.

    7. **Controllers** (`project_controller.go`, `modul_controller.go`):
       - Add `ctx := c.UserContext()` in each handler.
       - Pass ctx to usecase calls.
       - Simplify AppError handling to `return err` where applicable.

    8. **Mocks** (`test_mocks.go`):
       - Update MockProjectRepository, MockModulRepository, MockProjectUsecase, MockModulUsecase.

    9. **Tests** (`project_usecase_test.go`, `modul_usecase_test.go`, `project_controller_test.go`, `modul_controller_test.go`):
       - Add `mock.Anything` for context in mock.On() calls.
       - Pass `context.Background()` to direct usecase/repo calls in tests.

    10. Run `go build ./...` to verify compilation.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./internal/usecase/... -count=1 -run "Project|Modul"` passes.
    `go test ./internal/controller/http/... -count=1 -run "Project|Modul"` passes.
  </verify>
  <done>
    Project and Modul domains fully context-propagated. All interfaces, implementations, controllers, mocks, and tests updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context.Context to Auth, Statistic, and Health domains</name>
  <files>
    internal/usecase/auth_usecase.go
    internal/usecase/statistic_usecase.go
    internal/usecase/health_usecase.go
    internal/usecase/test_mocks.go
    internal/controller/http/auth_controller.go
    internal/controller/http/statistic_controller.go
    internal/controller/http/health_controller.go
    internal/usecase/auth_usecase_test.go
    internal/usecase/statistic_usecase_test.go
    internal/usecase/health_usecase_test.go
    internal/controller/http/auth_controller_test.go
    internal/controller/http/statistic_controller_test.go
    internal/controller/http/health_controller_test.go
    internal/usecase/auth_integration_test.go
  </files>
  <action>
    1. **AuthUsecase interface + implementation** (`auth_usecase.go`):
       - Add `ctx context.Context` to all AuthUsecase interface methods.
       - The domain.AuthService interface already uses context.Context (6 of 7 methods). Thread the controller's context through to AuthService calls.
       - For the AuthUsecase methods that call UserRepository (already updated in Plan 05-03), pass ctx.

    2. **StatisticUsecase interface + implementation** (`statistic_usecase.go`):
       - Add `ctx context.Context` to all StatisticUsecase interface methods.
       - StatisticUsecase likely uses repos already updated (User, Project, Modul). Pass ctx through.

    3. **HealthUsecase interface + implementation** (`health_usecase.go`):
       - Add `ctx context.Context` to all HealthUsecase interface methods.
       - HealthUsecase likely uses `*gorm.DB` directly (not via repository). Add `db.WithContext(ctx)` to direct DB calls.

    4. **Controllers** (`auth_controller.go`, `statistic_controller.go`, `health_controller.go`):
       - Add `ctx := c.UserContext()` in each handler.
       - Pass ctx to usecase calls.
       - Simplify AppError handling where applicable.

    5. **Mocks** (`test_mocks.go`):
       - Update MockAuthUsecase, MockStatisticUsecase, MockHealthUsecase.

    6. **Tests**:
       - Update all test files for Auth, Statistic, Health with `mock.Anything` for context.
       - `auth_integration_test.go`: Update integration test calls to pass context.

    7. Run `go build ./...` and `go test ./... -count=1`.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./... -count=1` passes (full test suite).
    `grep -c "ctx context.Context" internal/usecase/repo/interfaces.go` shows the total count from all domains (30 from Plan 05-03 + 15 from this plan = 45, excluding TUS).
  </verify>
  <done>
    Auth, Statistic, and Health domains fully context-propagated. All non-TUS domains now accept context.Context.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./... -count=1` passes
3. Project (7), Modul (8), Auth, Statistic, Health repo/usecase methods all have context.Context
4. All implementations use db.WithContext(ctx)
5. Controllers use c.UserContext()
6. Background goroutines (cleanup) use context.Background(), not request context
</verification>

<success_criteria>
- All non-TUS domains have context.Context propagated through controller -> usecase -> repository
- GORM queries use WithContext(ctx) in all repository implementations
- All mocks and tests updated
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-deep-architecture-improvements/05-04-SUMMARY.md`
</output>
