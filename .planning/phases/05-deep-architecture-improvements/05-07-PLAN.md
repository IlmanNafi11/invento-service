---
phase: 05-deep-architecture-improvements
plan: 07
type: execute
wave: 6
depends_on: ["05-05"]
files_modified:
  - internal/helper/casbin_test.go
  - internal/usecase/repo/test/tus_repository_test.go
  - internal/errors/errors_test.go
  - internal/middleware/integration_test.go
  - internal/domain/project_test.go
  - internal/middleware/validation_test.go
  - internal/usecase/project_usecase_test.go
  - internal/usecase/tus_upload_usecase_test.go
  - internal/integration_test.go
  - internal/httputil/cookie_helper_test.go
  - internal/helper/rbac_helper_test.go
  - internal/usecase/tus_modul_usecase_test.go
  - internal/usecase/repo/role_permission_repository_coverage_test.go
  - internal/controller/http/modul_controller_test.go
autonomous: true

must_haves:
  truths:
    - "All 14 remaining oversized test files (501-750 lines) are split into focused files under 500 lines each"
    - "Split test files maintain the same test coverage"
    - "go test ./... -count=1 passes"
  artifacts: []
  key_links: []
---

<objective>
Split the remaining 14 oversized test files (501-750 lines) into focused files under 500 lines each. This plan runs in parallel with Plan 05-06 since it touches entirely different files.

Purpose: Complete the 500-line enforcement for all test files in the project.
Output: All test files under 500 lines.
</objective>

<execution_context>
@/home/ilmannafi/.claude/get-shit-done/workflows/execute-plan.md
@/home/ilmannafi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deep-architecture-improvements/05-RESEARCH.md
@.planning/phases/05-deep-architecture-improvements/05-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split remaining oversized test files (batch A: 7 files)</name>
  <files>
    internal/helper/casbin_test.go
    internal/usecase/repo/test/tus_repository_test.go
    internal/errors/errors_test.go
    internal/middleware/integration_test.go
    internal/domain/project_test.go
    internal/middleware/validation_test.go
    internal/usecase/project_usecase_test.go
  </files>
  <action>
    Split each file by concern, targeting 200-400 lines per resulting file:

    1. `casbin_test.go` (757 lines): Split by casbin operation:
       - `casbin_enforcer_test.go`, `casbin_policy_test.go`

    2. `tus_repository_test.go` (754 lines): Split by entity:
       - `tus_upload_repository_test.go`, `tus_modul_upload_repository_test.go`

    3. `errors_test.go` (743 lines): Split by error type:
       - `errors_apperror_test.go`, `errors_sentinel_test.go`, `errors_helpers_test.go`

    4. `integration_test.go` (734 lines in middleware/): Split by middleware tested:
       - `integration_auth_test.go`, `integration_rbac_test.go`, `integration_validation_test.go`

    5. `project_test.go` (731 lines in domain/): Split by test concern:
       - `project_validation_test.go`, `project_model_test.go`

    6. `validation_test.go` (721 lines): Split by validation rule:
       - `validation_struct_test.go`, `validation_rules_test.go`

    7. `project_usecase_test.go` (717 lines): Split by operation:
       - `project_usecase_crud_test.go`, `project_usecase_download_test.go`

    **For each split:**
    - Read the test file, identify logical groups
    - Create new files with moved test functions
    - Keep shared helpers accessible (same package, or extract to testhelpers)
    - Ensure correct package declaration and imports
    - Delete original file after splitting
    - Verify each file under 500 lines

    Run `go build ./...` after each batch of 2-3 splits.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./... -count=1` passes.
    `wc -l` on all resulting files shows under 500 lines each.
  </verify>
  <done>
    7 test files split into focused files under 500 lines. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Split remaining oversized test files (batch B: 7 files)</name>
  <files>
    internal/usecase/tus_upload_usecase_test.go
    internal/integration_test.go
    internal/httputil/cookie_helper_test.go
    internal/helper/rbac_helper_test.go
    internal/usecase/tus_modul_usecase_test.go
    internal/usecase/repo/role_permission_repository_coverage_test.go
    internal/controller/http/modul_controller_test.go
  </files>
  <action>
    Split each file by concern:

    1. `tus_upload_usecase_test.go` (663 lines): Split by TUS operation:
       - `tus_upload_usecase_init_test.go`, `tus_upload_usecase_chunk_test.go`

    2. `integration_test.go` (639 lines in internal/): Split by scope:
       - `integration_setup_test.go`, `integration_api_test.go`

    3. `cookie_helper_test.go` (635 lines): Split by cookie operation:
       - `cookie_helper_set_test.go`, `cookie_helper_get_test.go`

    4. `rbac_helper_test.go` (619 lines): Split by RBAC concern:
       - `rbac_helper_check_test.go`, `rbac_helper_setup_test.go`

    5. `tus_modul_usecase_test.go` (573 lines): Split by operation:
       - `tus_modul_usecase_init_test.go`, `tus_modul_usecase_chunk_test.go`

    6. `role_permission_repository_coverage_test.go` (570 lines): Split by operation type:
       - `role_permission_repo_crud_test.go`, `role_permission_repo_query_test.go`

    7. `modul_controller_test.go` (501 lines): Split by CRUD or keep and trim:
       - If just over 500, see if it can be trimmed (remove duplicate test helpers). Otherwise split:
       - `modul_controller_crud_test.go`, `modul_controller_download_test.go`

    **Same process as Task 1 for each split.**

    Run `go build ./...` and `go test ./... -count=1` at the end.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./... -count=1` passes.
    `find . -name "*_test.go" -exec wc -l {} \; | awk '$1 > 500'` returns ZERO results (no test files over 500 lines).
  </verify>
  <done>
    All remaining oversized test files split. No test file in the project exceeds 500 lines.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./... -count=1` passes
3. `find . -name "*_test.go" -exec wc -l {} \; | awk '$1 > 500'` returns zero results
4. No tests lost (same test count before and after)
</verification>

<success_criteria>
- All 14 remaining oversized test files split into focused files
- Every test file in the project is under 500 lines
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-deep-architecture-improvements/05-07-SUMMARY.md`
</output>
