---
phase: 05-deep-architecture-improvements
plan: 05
type: execute
wave: 5
depends_on: ["05-04"]
files_modified:
  - internal/usecase/repo/interfaces.go
  - internal/usecase/repo/tus_upload_repository.go
  - internal/usecase/repo/tus_modul_upload_repository.go
  - internal/usecase/tus_upload_usecase.go
  - internal/usecase/tus_modul_usecase.go
  - internal/usecase/test_mocks.go
  - internal/controller/http/tus_controller.go
  - internal/controller/http/tus_modul_controller.go
  - internal/controller/http/tus_helpers.go
  - internal/usecase/tus_upload_usecase_test.go
  - internal/usecase/tus_modul_usecase_test.go
  - internal/controller/http/tus_controller_test.go
  - internal/usecase/tus_integration_test.go
  - internal/usecase/repo/test/tus_repository_test.go
  - internal/helper/tus_manager.go
  - internal/helper/test/tus_helper_test.go
autonomous: true

must_haves:
  truths:
    - "Every TusUploadRepository method accepts context.Context as first parameter"
    - "Every TusModulUploadRepository method accepts context.Context as first parameter"
    - "Every TusUploadUsecase and TusModulUsecase method accepts context.Context as first parameter"
    - "TUS controllers extract c.UserContext() and pass it through"
    - "Background cleanup goroutines use context.Background(), NOT request context"
    - "All repository implementations use db.WithContext(ctx)"
    - "go build ./... compiles with zero errors"
    - "go test ./... -count=1 passes"
    - "EVERY repository, usecase, and controller interface method in the project now accepts context.Context"
  artifacts:
    - path: "internal/usecase/repo/interfaces.go"
      provides: "COMPLETE interfaces file with context.Context on ALL repository methods across all domains"
  key_links:
    - from: "internal/controller/http/tus_controller.go"
      to: "internal/usecase/tus_upload_usecase.go"
      via: "c.UserContext() passed as ctx"
      pattern: "c\\.UserContext\\(\\)"
    - from: "internal/usecase/tus_upload_usecase.go"
      to: "internal/usecase/repo/tus_upload_repository.go"
      via: "ctx passed to all repo calls"
      pattern: "ctx,"
    - from: "internal/helper/tus_manager.go"
      to: "context.Background()"
      via: "background cleanup operations must not use request context"
      pattern: "context\\.Background\\(\\)"
---

<objective>
Add context.Context propagation to TUS Upload and TUS Modul Upload domains -- the largest domain group with the most methods. Complete context propagation for the entire project.

Purpose: Finish context propagation across all layers, achieving Success Criterion #1 (every interface method accepts context.Context).
Output: All TUS repository, usecase, and controller methods accept context.Context. Project-wide context propagation complete.
</objective>

<execution_context>
@/home/ilmannafi/.claude/get-shit-done/workflows/execute-plan.md
@/home/ilmannafi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deep-architecture-improvements/05-RESEARCH.md
@.planning/phases/05-deep-architecture-improvements/05-04-SUMMARY.md

@internal/usecase/repo/interfaces.go
@internal/usecase/tus_upload_usecase.go
@internal/usecase/tus_modul_usecase.go
@internal/controller/http/tus_controller.go
@internal/controller/http/tus_modul_controller.go
@internal/helper/tus_manager.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context.Context to TUS Upload domain</name>
  <files>
    internal/usecase/repo/interfaces.go
    internal/usecase/repo/tus_upload_repository.go
    internal/usecase/tus_upload_usecase.go
    internal/usecase/test_mocks.go
    internal/controller/http/tus_controller.go
    internal/controller/http/tus_helpers.go
    internal/usecase/tus_upload_usecase_test.go
    internal/controller/http/tus_controller_test.go
    internal/usecase/tus_integration_test.go
    internal/usecase/repo/test/tus_repository_test.go
    internal/helper/tus_manager.go
    internal/helper/test/tus_helper_test.go
  </files>
  <action>
    1. **TusUploadRepository interface** (`interfaces.go`):
       - Add `ctx context.Context` to all 14 methods: Create, GetByID, GetByUserID, GetActiveByUserID, CountActiveByUserID, UpdateOffset, UpdateStatus, Complete, GetExpiredUploads, GetAbandonedUploads, Delete, ListActive, GetActiveUploadIDs.

    2. **TusUploadRepository implementation** (`tus_upload_repository.go`):
       - Add ctx to each method, use `r.db.WithContext(ctx)` for all GORM queries.

    3. **TusUploadUsecase interface + implementation** (`tus_upload_usecase.go`):
       - Add ctx to all TusUploadUsecase interface methods.
       - Pass ctx to repository and other service calls.
       - CRITICAL: Identify goroutines (cleanup, expiration checks). These MUST use `context.Background()` instead of the request context. The request context gets cancelled when the HTTP response is sent -- any goroutine using it will fail.
       - Look for patterns like `go func() { ... repo.Delete(uploadID) ... }()` and ensure they use `context.Background()`.

    4. **TUS Controller** (`tus_controller.go`):
       - Add `ctx := c.UserContext()` in each handler.
       - Pass ctx to usecase calls.

    5. **TUS Helpers** (`tus_helpers.go`):
       - If helper functions call usecase/repo methods, add ctx parameter and thread it through.

    6. **TUS Manager** (`helper/tus_manager.go`):
       - If TusManager calls repository methods for cleanup/expiration, use `context.Background()` since these are background operations.
       - Add ctx parameter to TusManager methods that need it, but background goroutines within use `context.Background()`.

    7. **Mocks** (`test_mocks.go`):
       - Update MockTusUploadRepository and MockTusUploadUsecase.

    8. **Tests** (`tus_upload_usecase_test.go`, `tus_controller_test.go`, `tus_integration_test.go`, `tus_repository_test.go`, `tus_helper_test.go`):
       - Add `mock.Anything` for context in mock.On() calls.
       - Pass `context.Background()` to direct calls in tests.

    9. Run `go build ./...` to verify before proceeding.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./internal/usecase/... -count=1 -run "Tus"` passes (runs TUS upload tests, not modul yet).
    `go test ./internal/controller/http/... -count=1 -run "Tus"` passes (TUS controller tests).
    `grep "context.Background()" internal/usecase/tus_upload_usecase.go internal/helper/tus_manager.go` shows background context in cleanup goroutines.
  </verify>
  <done>
    TUS Upload domain fully context-propagated. Background operations use context.Background(). All TUS upload tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context.Context to TUS Modul Upload domain and verify complete propagation</name>
  <files>
    internal/usecase/repo/interfaces.go
    internal/usecase/repo/tus_modul_upload_repository.go
    internal/usecase/tus_modul_usecase.go
    internal/usecase/test_mocks.go
    internal/controller/http/tus_modul_controller.go
    internal/usecase/tus_modul_usecase_test.go
  </files>
  <action>
    1. **TusModulUploadRepository interface** (`interfaces.go`):
       - Add `ctx context.Context` to all 11 methods: Create, GetByID, GetByUserID, UpdateOffset, UpdateStatus, Complete, Delete, GetExpiredUploads, GetAbandonedUploads, CountActiveByUserID, GetActiveByUserID, GetActiveUploadIDs.

    2. **TusModulUploadRepository implementation** (`tus_modul_upload_repository.go`):
       - Add ctx to each method, use `r.db.WithContext(ctx)`.

    3. **TusModulUsecase interface + implementation** (`tus_modul_usecase.go`):
       - Add ctx to all interface methods.
       - Pass ctx through to repo calls.
       - Same goroutine/background context considerations as TUS Upload.

    4. **Controller** (`tus_modul_controller.go`):
       - Add `ctx := c.UserContext()` in each handler.
       - Pass ctx to usecase calls.

    5. **Mocks** (`test_mocks.go`):
       - Update MockTusModulUploadRepository and MockTusModulUsecase.

    6. **Tests** (`tus_modul_usecase_test.go`):
       - Add `mock.Anything` for context.

    7. **Verify COMPLETE context propagation** across the entire project:
       ```bash
       # All repo interfaces should have ctx
       grep -c "ctx context.Context" internal/usecase/repo/interfaces.go
       # Expected: ~70 (all repo methods across all domains)

       # No repo/usecase interface method should be missing ctx
       grep "^\t[A-Z]" internal/usecase/repo/interfaces.go | grep -v "ctx context.Context" | grep -v "//"
       # Expected: empty (all methods have ctx)
       ```

    8. Run `go build ./...` and `go test ./... -count=1`.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./... -count=1` passes (FULL test suite).
    `grep "^\t[A-Z]" internal/usecase/repo/interfaces.go | grep -v "ctx context.Context" | grep -v "//"` returns EMPTY (no methods missing ctx).
    Every controller file contains `c.UserContext()`.
    Every repository implementation uses `db.WithContext(ctx)`.
  </verify>
  <done>
    TUS Modul Upload domain context-propagated. ALL domains now have complete context.Context propagation from controller through usecase to repository. Success Criterion #1 achieved.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./... -count=1` passes
3. ALL repository interface methods (70+) have context.Context as first param
4. ALL usecase interface methods have context.Context as first param
5. ALL controllers use c.UserContext()
6. ALL repository implementations use db.WithContext(ctx)
7. Background goroutines use context.Background(), not request context
8. Project-wide context propagation COMPLETE
</verification>

<success_criteria>
- TUS Upload (14 repo methods) and TUS Modul (11 repo methods) have context.Context
- Every repository, usecase, and controller in the project accepts context.Context
- Background operations properly isolated from request context
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-deep-architecture-improvements/05-05-SUMMARY.md`
</output>
