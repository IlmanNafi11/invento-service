---
phase: 05-deep-architecture-improvements
plan: 06
type: execute
wave: 6
depends_on: ["05-05"]
files_modified:
  - internal/usecase/test_mocks.go
  - internal/helper/test/tus_helper_test.go
  - internal/controller/http/user_controller_test.go
  - internal/usecase/user_usecase_test.go
  - internal/controller/http/tus_controller_test.go
  - internal/httputil/validator_test.go
  - internal/domain/tus_upload_test.go
  - internal/app/server_test.go
  - internal/usecase/auth_usecase_test.go
  - internal/controller/http/project_controller_test.go
  - internal/usecase/statistic_usecase_test.go
  - internal/storage/file_test.go
  - internal/usecase/role_usecase_test.go
  - internal/helper/middleware_test.go
  - internal/domain/tus_modul_upload_test.go
  - internal/usecase/modul_usecase_test.go
autonomous: true

must_haves:
  truths:
    - "test_mocks.go is split into domain-specific mock files, each under 500 lines"
    - "Top 15 oversized test files (>750 lines) are split into focused files, each under 500 lines"
    - "Split test files maintain the same test coverage (no tests lost)"
    - "go test ./... -count=1 passes"
  artifacts:
    - path: "internal/usecase/role_mocks_test.go"
      provides: "Role/Permission mock implementations"
    - path: "internal/usecase/user_mocks_test.go"
      provides: "User mock implementations"
    - path: "internal/usecase/project_mocks_test.go"
      provides: "Project mock implementations"
    - path: "internal/usecase/tus_mocks_test.go"
      provides: "TUS Upload and TUS Modul mock implementations"
    - path: "internal/usecase/auth_mocks_test.go"
      provides: "Auth mock implementations"
  key_links:
    - from: "internal/usecase/*_test.go"
      to: "internal/usecase/*_mocks_test.go"
      via: "test files reference mocks from split mock files (same package)"
      pattern: "Mock\\w+Repository|Mock\\w+Usecase"
---

<objective>
Split test_mocks.go (603 lines, over 500-line limit) into domain-specific mock files, and split the top 15 largest test files (>750 lines) into focused files under 500 lines each.

Purpose: Enforce the 500-line file limit on test files and improve test organization by concern.
Output: All split mock files and test files under 500 lines, zero tests lost.
</objective>

<execution_context>
@/home/ilmannafi/.claude/get-shit-done/workflows/execute-plan.md
@/home/ilmannafi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deep-architecture-improvements/05-RESEARCH.md
@.planning/phases/05-deep-architecture-improvements/05-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split test_mocks.go into domain-specific mock files</name>
  <files>
    internal/usecase/test_mocks.go
  </files>
  <action>
    Split `internal/usecase/test_mocks.go` (603 lines) by domain. Since mocks are used in tests within the same package, the new files should use `_test.go` suffix OR stay as non-test files in the same package. Choose whichever approach the current codebase uses.

    Create domain-specific mock files:
    - `internal/usecase/role_mocks_test.go` -- MockRoleRepository, MockPermissionRepository, MockRolePermissionRepository, MockRoleUsecase
    - `internal/usecase/user_mocks_test.go` -- MockUserRepository, MockUserUsecase
    - `internal/usecase/project_mocks_test.go` -- MockProjectRepository, MockProjectUsecase
    - `internal/usecase/modul_mocks_test.go` -- MockModulRepository, MockModulUsecase
    - `internal/usecase/tus_mocks_test.go` -- MockTusUploadRepository, MockTusModulUploadRepository, MockTusUploadUsecase, MockTusModulUsecase
    - `internal/usecase/auth_mocks_test.go` -- MockAuthUsecase, MockAuthService
    - `internal/usecase/statistic_mocks_test.go` -- MockStatisticUsecase
    - `internal/usecase/health_mocks_test.go` -- MockHealthUsecase

    NOTE: If test_mocks.go is NOT a `_test.go` file (it's `test_mocks.go`), check if mocks are imported by other packages. If they are imported by controller tests, the mocks CANNOT be in `_test.go` files (those are package-private). In that case:
    - Keep the split files as regular `.go` files (e.g., `role_mocks.go`, `user_mocks.go`)
    - OR move them to a `internal/usecase/mocks/` sub-package if imported externally

    Check with: `grep -rn "usecase\.Mock" internal/ --include="*.go" | grep -v "usecase/"` to see if mocks are used outside the usecase package.

    Each resulting file should:
    - Have the correct package declaration
    - Have necessary imports (testify/mock, domain, context, etc.)
    - Be under 500 lines

    Delete the original `test_mocks.go` after splitting.

    Run `go build ./...` to verify compilation.
  </action>
  <verify>
    `go build ./...` passes.
    `ls internal/usecase/*mock*` shows domain-specific mock files.
    `! test -f internal/usecase/test_mocks.go` (original file deleted).
    `wc -l internal/usecase/*mock*` shows all files under 500 lines.
    `go test ./internal/usecase/... -count=1` passes.
  </verify>
  <done>
    test_mocks.go split into domain-specific mock files, each under 500 lines. Original file deleted. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Split top 15 oversized test files (>750 lines)</name>
  <files>
    internal/helper/test/tus_helper_test.go
    internal/controller/http/user_controller_test.go
    internal/usecase/user_usecase_test.go
    internal/controller/http/tus_controller_test.go
    internal/httputil/validator_test.go
    internal/domain/tus_upload_test.go
    internal/app/server_test.go
    internal/usecase/auth_usecase_test.go
    internal/controller/http/project_controller_test.go
    internal/usecase/statistic_usecase_test.go
    internal/storage/file_test.go
    internal/usecase/role_usecase_test.go
    internal/helper/middleware_test.go
    internal/domain/tus_modul_upload_test.go
    internal/usecase/modul_usecase_test.go
  </files>
  <action>
    Split each oversized test file by concern, targeting 200-400 lines per resulting file. Use mirror-source naming (per research recommendation).

    **Split strategy per file:**

    1. `tus_helper_test.go` (2009 lines): Split by TUS operation:
       - `tus_helper_store_test.go`, `tus_helper_queue_test.go`, `tus_helper_manager_test.go`, `tus_helper_cleanup_test.go`

    2. `user_controller_test.go` (1323 lines): Split by handler:
       - `user_controller_profile_test.go`, `user_controller_list_test.go`, `user_controller_role_test.go`, `user_controller_files_test.go`

    3. `user_usecase_test.go` (1262 lines): Split by operation:
       - `user_usecase_crud_test.go`, `user_usecase_profile_test.go`, `user_usecase_permissions_test.go`

    4. `tus_controller_test.go` (1198 lines): Split by TUS operation:
       - `tus_controller_upload_test.go`, `tus_controller_chunk_test.go`, `tus_controller_status_test.go`

    5. `validator_test.go` (1043 lines): Split by validator type:
       - `validator_struct_test.go`, `validator_field_test.go`, `validator_custom_test.go`

    6. `tus_upload_test.go` (1005 lines): Split by test concern:
       - `tus_upload_status_test.go`, `tus_upload_validation_test.go`, `tus_upload_lifecycle_test.go`

    7. `server_test.go` (975 lines): Split by route group:
       - `server_auth_test.go`, `server_user_test.go`, `server_project_test.go`, `server_config_test.go`

    8. `auth_usecase_test.go` (918 lines): Split by auth operation:
       - `auth_usecase_login_test.go`, `auth_usecase_register_test.go`, `auth_usecase_token_test.go`

    9. `project_controller_test.go` (915 lines): Split by CRUD:
       - `project_controller_crud_test.go`, `project_controller_download_test.go`

    10. `statistic_usecase_test.go` (900 lines): Split by statistic type:
        - `statistic_usecase_admin_test.go`, `statistic_usecase_user_test.go`

    11. `file_test.go` (878 lines): Split by operation:
        - `file_read_test.go`, `file_write_test.go`, `file_path_test.go`

    12. `role_usecase_test.go` (849 lines): Split by CRUD:
        - `role_usecase_crud_test.go`, `role_usecase_permissions_test.go`

    13. `middleware_test.go` (787 lines): Split by middleware type:
        - `middleware_auth_test.go`, `middleware_rbac_test.go`, `middleware_tus_test.go`

    14. `tus_modul_upload_test.go` (780 lines): Split by concern:
        - `tus_modul_upload_status_test.go`, `tus_modul_upload_validation_test.go`

    15. `modul_usecase_test.go` (770 lines): Split by operation:
        - `modul_usecase_crud_test.go`, `modul_usecase_download_test.go`

    **For each split:**
    - Read the test file and identify logical groups of test functions
    - Create new files with appropriate test functions moved
    - Ensure each new file has: correct package declaration, necessary imports, shared test helpers (either copy or extract to a testutil file)
    - Shared setup functions (helper functions used by multiple test files): keep in the original file name or extract to a `testhelpers_test.go` file
    - Delete the original file after splitting
    - Verify each resulting file is under 500 lines

    Process in batches: after every 5 splits, run `go build ./...` to catch issues early.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./... -count=1` passes.
    `find . -name "*_test.go" -exec wc -l {} \; | awk '$1 > 500' | wc -l` shows count significantly reduced (remaining files are addressed in Plan 05-07).
    None of the 15 original oversized files exist (all replaced by splits).
  </verify>
  <done>
    Top 15 oversized test files (>750 lines) split into focused files under 500 lines each. All tests pass. No test coverage lost.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./... -count=1` passes
3. test_mocks.go no longer exists, replaced by domain-specific mock files
4. Top 15 test files split, each resulting file under 500 lines
5. `go test ./... -count=1 -v 2>&1 | grep "^---" | wc -l` shows same number of tests as before splitting
</verification>

<success_criteria>
- test_mocks.go split into 6-8 domain-specific files, each under 500 lines
- 15 largest test files split into focused files under 500 lines
- Zero tests lost during splitting
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-deep-architecture-improvements/05-06-SUMMARY.md`
</output>
