---
phase: 05-deep-architecture-improvements
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - internal/domain/user.go
  - internal/domain/role.go
  - internal/domain/project.go
  - internal/domain/modul.go
  - internal/domain/auth.go
  - internal/domain/statistic.go
  - internal/domain/health.go
  - internal/domain/tus_upload.go
  - internal/domain/tus_modul_upload.go
  - internal/dto/user.go
  - internal/dto/role.go
  - internal/dto/project.go
  - internal/dto/modul.go
  - internal/dto/auth.go
  - internal/dto/statistic.go
  - internal/dto/health.go
  - internal/dto/tus.go
  - internal/controller/http/auth_controller.go
  - internal/controller/http/user_controller.go
  - internal/controller/http/role_controller.go
  - internal/controller/http/project_controller.go
  - internal/controller/http/modul_controller.go
  - internal/controller/http/statistic_controller.go
  - internal/controller/http/health_controller.go
  - internal/controller/http/tus_controller.go
  - internal/controller/http/tus_modul_controller.go
  - internal/controller/http/tus_helpers.go
  - internal/usecase/user_usecase.go
  - internal/usecase/role_usecase.go
  - internal/usecase/project_usecase.go
  - internal/usecase/modul_usecase.go
  - internal/usecase/auth_usecase.go
  - internal/usecase/statistic_usecase.go
  - internal/usecase/health_usecase.go
  - internal/usecase/tus_upload_usecase.go
  - internal/usecase/tus_modul_usecase.go
  - internal/usecase/test_mocks.go
  - internal/usecase/repo/interfaces.go
  - internal/usecase/repo/user_repository.go
  - internal/usecase/repo/role_repository.go
  - internal/usecase/repo/permission_repository.go
  - internal/usecase/repo/project_repository.go
  - internal/usecase/repo/modul_repository.go
  - internal/usecase/repo/tus_upload_repository.go
  - internal/usecase/repo/tus_modul_upload_repository.go
  - internal/storage/user_helper.go
  - internal/testing/fixtures.go
  - internal/helper/tus_manager.go
autonomous: true

must_haves:
  truths:
    - "All request/response DTO types live in internal/dto/, not in internal/domain/"
    - "Domain model files (internal/domain/*.go) contain ONLY GORM entity structs, interfaces, TableName methods, constants, and BeforeCreate hooks"
    - "DTO naming follows Action + Entity + Type convention (CreateProjectRequest, not ProjectCreateReq)"
    - "Validation tags exist only on DTO types, not on domain models"
    - "go build ./... compiles with zero errors"
    - "go test ./... -count=1 passes"
  artifacts:
    - path: "internal/dto/user.go"
      provides: "User request/response DTOs (UserListQueryParams, ProfileData, UpdateProfileRequest, etc.)"
    - path: "internal/dto/role.go"
      provides: "Role request/response DTOs (RoleCreateRequest, RoleDetailResponse, etc.)"
    - path: "internal/dto/project.go"
      provides: "Project request/response DTOs (CreateProjectRequest, ProjectResponse, etc.)"
    - path: "internal/dto/modul.go"
      provides: "Modul request/response DTOs (UpdateModulRequest, ModulResponse, etc.)"
    - path: "internal/dto/auth.go"
      provides: "Auth request/response DTOs (AuthRequest, RegisterRequest, AuthResponse, etc.)"
    - path: "internal/dto/statistic.go"
      provides: "Statistic DTOs (StatisticData, StatisticResponse)"
    - path: "internal/dto/health.go"
      provides: "Health check DTOs (BasicHealthCheck, ComprehensiveHealthCheck, SystemMetrics, etc.)"
    - path: "internal/dto/tus.go"
      provides: "TUS upload DTOs (TusUploadInitRequest, TusUploadResponse, etc.)"
  key_links:
    - from: "internal/controller/http/*.go"
      to: "internal/dto/*.go"
      via: "controllers reference dto types for request parsing and response building"
      pattern: "dto\\."
    - from: "internal/dto/*.go"
      to: "internal/domain/*.go"
      via: "mapping functions convert between dto and domain types using copier"
      pattern: "copier\\.Copy|CopyStruct"
---

<objective>
Move all request/response types from internal/domain/ to internal/dto/, following the locked naming convention (Action + Entity + Type). Create mapping functions using jinzhu/copier. Update all consumers across the codebase.

Purpose: Separate API contracts (DTOs) from domain models (GORM entities), preventing domain models from leaking HTTP/validation concerns.
Output: Clean dto/ package with all request/response types, domain/ package with only GORM entities and interfaces.
</objective>

<execution_context>
@/home/ilmannafi/.claude/get-shit-done/workflows/execute-plan.md
@/home/ilmannafi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deep-architecture-improvements/05-RESEARCH.md
@.planning/phases/05-deep-architecture-improvements/05-01-SUMMARY.md

@internal/domain/user.go
@internal/domain/role.go
@internal/domain/project.go
@internal/domain/modul.go
@internal/domain/auth.go
@internal/domain/statistic.go
@internal/domain/health.go
@internal/domain/tus_upload.go
@internal/domain/tus_modul_upload.go
@internal/dto/common.go
@internal/dto/request.go
@internal/dto/response.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DTO files and move types from domain</name>
  <files>
    internal/dto/user.go
    internal/dto/role.go
    internal/dto/project.go
    internal/dto/modul.go
    internal/dto/auth.go
    internal/dto/statistic.go
    internal/dto/health.go
    internal/dto/tus.go
    internal/domain/user.go
    internal/domain/role.go
    internal/domain/project.go
    internal/domain/modul.go
    internal/domain/auth.go
    internal/domain/statistic.go
    internal/domain/health.go
    internal/domain/tus_upload.go
    internal/domain/tus_modul_upload.go
  </files>
  <action>
    Move request/response types from domain files to dto files. Apply the naming convention: Action + Entity + Type (fully spelled out, per locked decision).

    **From domain/user.go -> dto/user.go:**
    - UserListQueryParams, UserListItem, UserListData, UpdateUserRoleRequest, ProfileData, UpdateProfileRequest, UserFileItem, UserFilesQueryParams, UserFilesData, UserPermissionItem, DownloadUserFilesRequest, BulkAssignRoleRequest
    - Keep in domain/user.go: User struct (GORM entity) + TableName()

    **From domain/role.go -> dto/role.go:**
    - RoleCreateRequest, RoleUpdateRequest, RoleListQueryParams, RoleListItem, RolePermissionDetail, RoleDetailResponse, PermissionItem, ResourcePermissions, RoleListData
    - Keep in domain/role.go: Role, Permission, RolePermission structs (GORM entities)

    **From domain/project.go -> dto/project.go:**
    - ProjectCreateRequest -> CreateProjectRequest (rename to match convention)
    - ProjectUpdateRequest -> UpdateProjectRequest (rename)
    - ProjectListQueryParams, ProjectListItem, ProjectListData, ProjectResponse, ProjectDownloadRequest
    - Keep in domain/project.go: Project struct (GORM entity)

    **From domain/modul.go -> dto/modul.go:**
    - ModulUpdateRequest -> UpdateModulRequest (rename)
    - ModulListQueryParams, ModulListItem, ModulListData, ModulResponse, ModulDownloadRequest
    - Keep in domain/modul.go: Modul struct (GORM entity) + BeforeCreate() + TableName()

    **From domain/auth.go -> dto/auth.go:**
    - AuthServiceRegisterRequest, AuthServiceLoginRequest, AuthServiceResponse, AuthServiceUserInfo
    - AuthRequest, RegisterRequest, RefreshTokenRequest, ResetPasswordRequest
    - AuthUserResponse, AuthResponse, RefreshTokenResponse
    - Keep in domain/auth.go: AuthService interface, AuthClaims interface, User struct (already in user.go)
    - NOTE: AuthService interface methods reference AuthServiceRegisterRequest and AuthServiceResponse. After moving these to dto, the AuthService interface in domain/ must import dto/. This is acceptable: domain defines behavior, dto defines shapes. Alternatively, keep AuthServiceRegisterRequest and AuthServiceResponse in domain/ since they're part of the service interface contract. Use Claude's discretion -- whichever avoids circular imports.

    **From domain/statistic.go -> dto/statistic.go:**
    - StatisticRequest (empty struct, can be deleted), StatisticData, StatisticResponse

    **From domain/health.go -> dto/health.go:**
    - ALL types except the HealthStatus and ServiceStatus string type aliases and their constants (those are domain enums).
    - Move: BasicHealthCheck, AppInfo, DatabaseStatus, SystemInfo, DetailedSystemInfo, MemoryInfo, CPUInfo, RuntimeInfo, HttpMetrics, ResponseTimes, ServicesStatus, DatabaseService, EmailService, Dependency, ComprehensiveHealthCheck, SystemMetrics, ApplicationStatus
    - Keep in domain/health.go: HealthStatus type + constants, ServiceStatus type + constants

    **From domain/tus_upload.go -> dto/tus.go:**
    - TusUploadInitRequest (BUT keep a copy in domain/ WITHOUT validate tags since it's embedded in TusUpload GORM entity via `gorm:"serializer:json"`. The domain version has NO validate tags, the dto version HAS validate tags.)
    - TusUploadResponse, TusUploadInfoResponse, TusUploadSlotResponse
    - Keep in domain/tus_upload.go: TusUpload struct, upload status/type constants, TusUploadMetadata (renamed from TusUploadInitRequest, without validate tags)

    **From domain/tus_modul_upload.go -> check for request/response types and move to dto/tus.go**

    For types that use PaginationData (now in dto/response.go): the *ListData types reference PaginationData. Since both are now in dto/, no cross-package reference needed.

    For types that reference domain types (e.g., dto types that embed or reference domain models): use separate fields + mapping functions instead of embedding.

    Remove `validate` tags from domain model structs (User, Role, Project, etc.) if any exist. Validation tags belong ONLY on DTOs per locked decision.
  </action>
  <verify>
    `go build ./...` passes after all type moves.
    `grep -rn "type.*Request struct\|type.*Response struct\|type.*Data struct\|type.*Params struct" internal/domain/ --include="*.go"` shows only domain entities and AuthService contract types.
    Each dto file contains the expected types with correct naming convention.
  </verify>
  <done>
    All request/response types extracted from domain/ to dto/. Domain files contain only GORM entities, interfaces, constants, and hooks. DTO naming follows Action + Entity + Type convention.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all consumers and create mapping functions</name>
  <files>
    internal/controller/http/auth_controller.go
    internal/controller/http/user_controller.go
    internal/controller/http/role_controller.go
    internal/controller/http/project_controller.go
    internal/controller/http/modul_controller.go
    internal/controller/http/statistic_controller.go
    internal/controller/http/health_controller.go
    internal/controller/http/tus_controller.go
    internal/controller/http/tus_modul_controller.go
    internal/controller/http/tus_helpers.go
    internal/usecase/user_usecase.go
    internal/usecase/role_usecase.go
    internal/usecase/project_usecase.go
    internal/usecase/modul_usecase.go
    internal/usecase/auth_usecase.go
    internal/usecase/statistic_usecase.go
    internal/usecase/health_usecase.go
    internal/usecase/tus_upload_usecase.go
    internal/usecase/tus_modul_usecase.go
    internal/usecase/test_mocks.go
    internal/usecase/repo/interfaces.go
    internal/usecase/repo/user_repository.go
    internal/usecase/repo/role_repository.go
    internal/storage/user_helper.go
    internal/testing/fixtures.go
    internal/helper/tus_manager.go
  </files>
  <action>
    1. Update ALL import paths in consumers: replace `domain.TypeName` with `dto.TypeName` for every moved type. Add `"invento-service/internal/dto"` import where needed. Remove `domain` import where it's no longer used.

    2. Update repository interfaces and implementations:
       - `repo/interfaces.go`: If any method returns moved types (e.g., `[]domain.UserListItem`), update to `[]dto.UserListItem`. Same for `domain.RoleListItem`, `domain.ProjectListItem`, `domain.ModulListItem`, `domain.ResourcePermissions`.
       - `repo/user_repository.go`: Update return types for GetAll and GetProfileWithCounts.
       - `repo/role_repository.go`: Update return types for GetAll.
       - Other repo files: update as needed.

    3. Update usecase interfaces and implementations:
       - All usecase method signatures that accept or return moved types must reference dto.
       - Usecase implementations that construct response types (ProfileData, RoleDetailResponse, etc.) now use dto. types.

    4. Update controllers:
       - All request body parsing: `var req dto.CreateProjectRequest` instead of `var req domain.ProjectCreateRequest`.
       - All response building: use dto types.
       - Handle any renamed types (ProjectCreateRequest -> CreateProjectRequest, etc.).

    5. Update test mocks: mock return types must match updated interfaces.

    6. Update ALL test files that reference moved types (auth_controller_test.go, user_controller_test.go, role_controller_test.go, project_controller_test.go, modul_controller_test.go, statistic_controller_test.go, health_controller_test.go, tus_controller_test.go, etc.).

    7. Update storage/user_helper.go, testing/fixtures.go, helper/tus_manager.go if they reference moved types.

    8. Run `go build ./...` after each domain group to catch errors early.

    9. Run `go test ./... -count=1` at the end to verify no regressions.

    NOTE on copier mapping: For this plan, direct field assignment or copier.Copy can be used where domain-to-DTO conversion is needed. Create mapping functions in the relevant dto files (e.g., `dto/project.go` has `func ProjectToResponse(p *domain.Project) *ProjectResponse`). Use copier for complex mappings, direct assignment for trivial ones.

    NOTE on Swagger: After all type moves, run `swag init` to regenerate Swagger docs if the project uses it. Update Swagger annotations in controllers to reference dto types.
  </action>
  <verify>
    `go build ./...` passes.
    `go test ./... -count=1` passes.
    `grep -rn "domain\.\(UserList\|RoleCreate\|RoleUpdate\|RoleDetail\|RoleList\|ProjectCreate\|ProjectUpdate\|ProjectList\|ProjectDownload\|ModulUpdate\|ModulList\|ModulDownload\|ModulResponse\|ProfileData\|UserFiles\|DownloadUser\|BulkAssign\|StatisticData\|StatisticResponse\|StatisticRequest\|BasicHealth\|ComprehensiveHealth\|SystemMetrics\|ApplicationStatus\|AuthRequest\|RegisterRequest\|RefreshToken\|ResetPassword\|AuthUserResponse\|AuthResponse\|TusUpload.*Response\|TusUploadSlot\)" internal/ --include="*.go"` returns zero results.
  </verify>
  <done>
    All consumers updated to reference dto types. Mapping functions created. All tests pass. Zero references to moved types in domain/.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./... -count=1` passes
3. `internal/domain/*.go` files contain only GORM entities, interfaces, constants, hooks
4. `internal/dto/*.go` files contain all request/response types with proper naming
5. No domain-specific request/response types remain in domain/ (only shared contract types if needed for AuthService interface)
6. Mapping functions exist for domain-to-DTO conversions
</verification>

<success_criteria>
- All request/response DTOs live in internal/dto/
- Domain models are clean (GORM entities only)
- DTO naming follows Action + Entity + Type convention
- Validation tags only on DTOs
- All consumers updated
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-deep-architecture-improvements/05-02-SUMMARY.md`
</output>
